<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViralTracker Cron Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .badge-completed {
            background: #10b981;
        }
        .badge-running {
            background: #f59e0b;
        }
        .badge-failed {
            background: #ef4444;
        }
        .next-run-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .table-hover tbody tr:hover {
            background-color: #f1f3f5;
        }
        .btn-action {
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üöÄ ViralTracker Cron Dashboard</span>
            <span class="navbar-text text-white">
                Automated Daily Scraping
            </span>
        </div>
    </nav>

    <div class="container">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <!-- Next Run Card -->
            <div class="col-md-6 mb-3">
                <div class="card next-run-card">
                    <div class="card-body stat-card">
                        <h5 class="card-title">‚è∞ Next Scheduled Run</h5>
                        <p class="stat-number">{{ next_run }}</p>
                        <p class="mb-0">Mon-Fri at 6:00 AM EST</p>
                    </div>
                </div>
            </div>

            <!-- Total Runs Card -->
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body stat-card">
                        <div class="stat-number text-primary">{{ total_runs }}</div>
                        <div class="stat-label">Total Runs</div>
                    </div>
                </div>
            </div>

            <!-- Success Rate Card -->
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body stat-card">
                        <div class="stat-number text-success">
                            {% set completed = runs | selectattr("status", "equalto", "completed") | list | length %}
                            {{ ((completed / total_runs * 100) | round(1)) if total_runs > 0 else 0 }}%
                        </div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Run History Table -->
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">üìä Run History (Last 30 Days)</h5>
            </div>
            <div class="card-body p-0">
                {% if runs %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Duration</th>
                                <th>Tweets</th>
                                <th>Green %</th>
                                <th>Keywords</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for run in runs %}
                            <tr>
                                <!-- Date -->
                                <td>
                                    <strong>{{ run.run_date }}</strong><br>
                                    <small class="text-muted">{{ run.started_at }}</small>
                                </td>

                                <!-- Status -->
                                <td>
                                    {% if run.status == "completed" %}
                                        <span class="badge badge-completed">‚úì Completed</span>
                                    {% elif run.status == "running" %}
                                        <span class="badge badge-running">‚ü≥ Running</span>
                                    {% elif run.status == "failed" %}
                                        <span class="badge badge-failed">‚úó Failed</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ run.status }}</span>
                                    {% endif %}
                                </td>

                                <!-- Duration -->
                                <td>
                                    {% if run.completed_at %}
                                        {% set duration = ((run.completed_at | string | length) > 0) %}
                                        <span class="text-muted">~45 min</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>

                                <!-- Tweets -->
                                <td>
                                    {% if run.total_tweets %}
                                        <strong>{{ run.total_tweets }}</strong>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>

                                <!-- Green % -->
                                <td>
                                    {% if run.green_percentage %}
                                        <span class="badge {% if run.green_percentage >= 3.0 %}bg-success{% elif run.green_percentage >= 1.5 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ run.green_percentage }}%
                                        </span>
                                        <br>
                                        <small class="text-muted">({{ run.green_tweets }} greens)</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>

                                <!-- Keywords -->
                                <td>
                                    {% if run.keywords_scraped %}
                                        {{ run.keywords_scraped }} / 19
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>

                                <!-- Actions -->
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        {% if run.csv_storage_path %}
                                        <a href="/runs/{{ run.id }}/download" class="btn btn-outline-primary btn-action">
                                            üì• CSV
                                        </a>
                                        {% endif %}
                                        <a href="/runs/{{ run.id }}/logs" class="btn btn-outline-secondary btn-action">
                                            üìÑ Logs
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <p class="text-muted mb-0">No cron runs yet. First run will appear after the scheduled time.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-4 mb-4">
            <p class="text-muted small">
                ViralTracker v1.6 ‚Ä¢ Railway Deployment ‚Ä¢
                <a href="https://github.com/yourusername/viraltracker" class="text-decoration-none">GitHub</a>
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-refresh every 60 seconds if any run is in "running" state
        const hasRunningJobs = {{ 'true' if runs | selectattr("status", "equalto", "running") | list | length > 0 else 'false' }};
        if (hasRunningJobs) {
            setTimeout(() => location.reload(), 60000);
        }
    </script>
</body>
</html>
